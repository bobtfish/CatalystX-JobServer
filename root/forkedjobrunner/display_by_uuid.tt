<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Hippie demo</title>
<script src="/static/jquery-1.3.2.min.js" type="text/javascript"></script>
<script src="/static/jquery.progressbar.min.js" type="text/javascript"></script>
<script src="/static/jquery.ev.js" type="text/javascript"></script>
<script src="/static/DUI.js" type="text/javascript"></script>
<script src="/static/Stream.js" type="text/javascript"></script>
<script src="/static/hippie.js" type="text/javascript"></script>
<script src="/static/json2.js" type="text/javascript"></script>
<script src="/static/dump.js" type="text/javascript"></script>
<script src="/static/joose.mini.js" type="text/javascript"></script>

<script type="text/javascript">

Module("CatalystX.JobServer.JobRunner.Forked.WorkerStatus", function (m) {
    Class("CompletionEstimate", {
        does: Joose.Storage,
        has: {
            step_count: {
                is: "ro",
                init: 0
            },
            steps_taken: {
                is: "ro",
                init: 0
            }
        },
        methods: {
            handleDisplay: function( display ) {
                var percentage = Math.floor(100 * parseInt(this.steps_taken) / parseInt(this.step_count));
                $(display.getRunning_jobs()[this.uuid].getProgress_bar_selector()).progressBar(percentage);
            }
        }
    });
    Class("StatusLine", {
        does: Joose.Storage,
        has: {
            status_info: {
                is: "ro",
                init: ""
            },
        },
        methods: {
            handleDisplay: function( display ) {
                $(display.getRunning_jobs()[this.uuid].getStatus_bar_selector()).text(this.getStatus_info());
            }
        }
    });
});
Module("CatalystX.JobServer.Job", function (m) {
    Class("Running", {
        does: Joose.Storage,
        has: {
            job: {
                is: "ro",
            },
            progress_bar_selector: {
                is: "rw",
            },
            status_bar_selector: {
                is: "rw"
            }
        },
        methods: {
            handleDisplay: function( display ) {
                this.setProgress_bar_selector('#progressBar' + this.job.uuid);
                this.setStatus_bar_selector('#statusBar' + this.job.uuid);
                $(display.getSelector()).append('<tr id="' + this.job.uuid + '"><td id="statusBar' + this.job.uuid + '"></td><td id="progressBar' + this.job.uuid + '"></td></tr>');
                $(this.progress_bar_selector).progressBar({ boxImage: '/static/images/progressbar.gif', barImage: '/static/images/progressbg.gif'});
                display.getRunning_jobs()[this.job.uuid] = this;
            }
        }
    });
    Class("Finished", {
        does: Joose.Storage,
        has: {
            job: {
                is: "ro",
            },
            progress_bar_selector: {
               is: "rw",
            }
        },
        methods: {
            handleDisplay: function( display ) {
                $(display.getRunning_jobs()[this.uuid].getProgress_bar_selector()).progressBar(100);
                delete display.getRunning_jobs()[this.job.uuid];
            }
        }
    });
});

Module("CatalystX.JobServer.JobDisplay", function (m) {
   Class("Hippie", {
       has: {
           hippie: {
               is: "ro",
               init: function () {
                   var that = this;
                   new Hippie(
                       document.location.host,
                       5, // Timeout
                       function() { that.connected() },
                       function() { that.disconnected() },
                       function(e) { that.handleMessage(e) },                                                  
                       "[% hippie_path %]"
                   );
               }
           },
           running_jobs: {
               is: "ro",
               init: {},
           },
           selector: {
               is: "ro"
           }
       },
       methods: {
           handleMessage: function (m) {
               var message;
               try {
                     message = Joose.Storage.Unpacker.unpack(m);
                     message.handleDisplay(this); // I love a nice bit of double dispatch
                 } catch (ex) {
                     log_it("got unhandled message, exception: " + ex + " message : " + dump(m));
                 }
           },
           connected: function () {},
           disconnected: function () {},
           displayInside: function (selector) {
               this.selector = selector;
               $(this.selector)
           }
       }
   });
});
     
function log_it(stuff) {
  $("#log").append(stuff+'<br/>');
}
$(function() {
  var manager = new CatalystX.JobServer.JobDisplay.Hippie();
  manager.displayInside("#progressbars"); 
});


</script>
<link rel="stylesheet" href="/static/screen.css" />
</head>
<body>


    <div id="content">

<table style="border: 1px" id="progressbars">
    <tr><th>Status</th><th>Completion %</th></tr>
</table>

        <div id="log">

        </div>

    </div>

</body>
</html>
